<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Image â†’ Prompt â€¢ AI Prompt Generator</title>

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- GSAP untuk animasi halus -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

  <!-- TensorFlow.js + MobileNet (client-side image recognition) -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.11.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@2.1.0/dist/mobilenet.min.js"></script>

  <style>
    /* Gradient background + subtle animated shapes */
    body {
      min-height: 100vh;
      background: radial-gradient(1200px 600px at 10% 10%, rgba(99,102,241,0.12), transparent 8%),
                  radial-gradient(1000px 400px at 90% 90%, rgba(236,72,153,0.06), transparent 6%),
                  linear-gradient(180deg, #05060a 0%, #0b1020 100%);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    /* Floating glass card shapes */
    .card {
      backdrop-filter: blur(6px) saturate(120%);
      background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));
      border: 1px solid rgba(255,255,255,0.04);
    }

    /* Animated pulse for loader */
    .pulse {
      animation: pulse 1.6s infinite;
    }
    @keyframes pulse {
      0% { opacity: 0.85; transform: scale(1); }
      50% { opacity: 0.5; transform: scale(0.985); }
      100% { opacity: 0.85; transform: scale(1); }
    }

    /* Small decorative blob */
    .blob {
      position: absolute;
      filter: blur(40px);
      opacity: 0.06;
      transform: translateZ(0);
    }

    /* Prompt textbox monospace */
    .prompt-box {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace;
      font-size: 14px;
      line-height: 1.45;
      white-space: pre-wrap;
      word-break: break-word;
    }

    /* Nice shadow override */
    .soft-shadow {
      box-shadow: 0 8px 30px rgba(2,6,23,0.6), inset 0 1px 0 rgba(255,255,255,0.02);
    }
  </style>
</head>
<body class="antialiased text-white">

  <!-- decorative blobs -->
  <div class="blob" style="width:360px;height:360px;left:-80px;top:10vh;background:linear-gradient(135deg,#6d28d9,#ec4899);border-radius:50%;"></div>
  <div class="blob" style="width:420px;height:420px;right:-120px;bottom:-40px;background:linear-gradient(135deg,#06b6d4,#7c3aed);border-radius:50%;"></div>

  <main class="max-w-[1100px] mx-auto py-12 px-6">
    <header class="mb-8 flex items-center justify-between">
      <div>
        <h1 class="text-3xl sm:text-4xl font-semibold">Image â†’ Prompt</h1>
        <p class="text-sm text-gray-300 mt-1">Unggah gambar, dapatkan prompt AI berkualitas â€” penuh opsi gaya & parameter.</p>
      </div>

      <div class="flex items-center gap-3">
        <button id="exampleBtn" class="px-4 py-2 rounded-lg card soft-shadow text-sm hover:scale-105 transition">Contoh gambar</button>
        <a href="#" id="downloadAll" class="px-4 py-2 rounded-lg card soft-shadow text-sm text-gray-200 hover:scale-105 transition">Download prompt</a>
      </div>
    </header>

    <section class="grid grid-cols-1 lg:grid-cols-3 gap-6">

      <!-- Left: uploader & preview -->
      <div class="lg:col-span-1 card p-4 rounded-xl soft-shadow relative">
        <div class="flex flex-col items-center gap-4">
          <div id="dropZone" class="w-full border-2 border-dashed border-white/6 rounded-lg p-3 cursor-pointer hover:border-white/20 transition">
            <input id="fileInput" type="file" accept="image/*" class="hidden">
            <div class="flex flex-col items-center justify-center gap-3 py-8">
              <div id="thumbWrap" class="w-[220px] h-[220px] bg-white/3 rounded-md flex items-center justify-center overflow-hidden relative">
                <img id="preview" alt="preview" class="max-w-full max-h-full object-cover" src="" style="display:none;">
                <div id="placeholder" class="text-center text-gray-300 px-4">
                  <div class="text-2xl">ðŸ“·</div>
                  <div class="text-xs mt-2">Drag & drop atau klik untuk unggah</div>
                </div>
              </div>
              <div class="text-sm text-gray-300">Mendukung JPG, PNG, WebP. Ukuran maksimum 8 MB.</div>
            </div>
          </div>

          <div class="w-full grid grid-cols-2 gap-3">
            <button id="analyzeBtn" class="px-3 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-500 transition">Analisis gambar</button>
            <button id="clearBtn" class="px-3 py-2 rounded-lg bg-white/6 hover:bg-white/8 transition">Bersihkan</button>
          </div>

          <div class="w-full mt-4 text-xs text-gray-400">
            Hasil analisis dilakukan sepenuhnya di browser (privasi terjaga). Untuk hasil paling akurat gunakan gambar yang jelas dan kontras.
          </div>
        </div>
      </div>

      <!-- Middle: generated prompt & controls -->
      <div class="lg:col-span-2 card p-6 rounded-xl soft-shadow relative">
        <div class="flex flex-col gap-4">
          <div class="flex items-center justify-between">
            <h2 class="text-xl font-medium">Prompt yang dihasilkan</h2>
            <div class="flex items-center gap-3">
              <select id="presetStyle" class="bg-transparent border border-white/6 rounded-md px-3 py-1 text-sm">
                <option value="">Pilih gaya cepat</option>
                <option value="anime">Anime â€” vibrant colors, detailed shading</option>
                <option value="photoreal">Photorealistic â€” highly detailed, cinematic lighting</option>
                <option value="digital-paint">Digital painting â€” brush strokes, painterly</option>
                <option value="cinematic">Cinematic â€” dramatic lighting, 35mm lens</option>
              </select>

              <button id="copyBtn" class="px-3 py-1 rounded-md bg-white/6 hover:bg-white/8 text-sm">Salin</button>
            </div>
          </div>

          <div id="promptBox" class="prompt-box p-4 rounded-md bg-black/30 min-h-[120px] card text-sm"></div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="p-3 rounded-md bg-black/20">
              <h3 class="font-medium text-sm mb-2">Detected labels</h3>
              <div id="labelsWrap" class="flex flex-wrap gap-2 text-xs"></div>
            </div>

            <div class="p-3 rounded-md bg-black/20">
              <h3 class="font-medium text-sm mb-2">Dominant colors</h3>
              <div id="colorsWrap" class="flex items-center gap-2"></div>
            </div>
          </div>

          <div class="flex flex-wrap gap-3 mt-3">
            <label class="flex items-center gap-2 text-xs">
              <input type="checkbox" id="inc_color" checked> sertakan warna
            </label>
            <label class="flex items-center gap-2 text-xs">
              <input type="checkbox" id="inc_style" checked> sertakan gaya (lighting, lens)
            </label>
            <label class="flex items-center gap-2 text-xs">
              <input type="checkbox" id="inc_detail" checked> tingkat detail tinggi (ultra-detailed)
            </label>
          </div>

          <div class="mt-4 flex gap-3">
            <button id="regenerateBtn" class="px-4 py-2 rounded-lg bg-amber-500 hover:bg-amber-400 transition">Regenerate</button>
            <button id="downloadPrompt" class="px-4 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-500 transition">Download .txt</button>
          </div>

          <div class="mt-4 text-xs text-gray-400">
            Tips: setelah mendapat prompt, kamu bisa menambahkan parameter model seperti <code>--v 5</code> atau <code>steps: 30</code> sesuai generator yang kamu gunakan.
          </div>
        </div>
      </div>

    </section>
  </main>

  <!-- Hidden canvas for color sampling -->
  <canvas id="sampleCanvas" width="256" height="256" style="display:none"></canvas>

  <script>
    // --- Utility: dominant color sampler (simple k-means-lite) ---
    function getDominantColorsFromImage(imgEl, count = 5) {
      const canvas = document.getElementById('sampleCanvas');
      const ctx = canvas.getContext('2d');

      // draw scaled image
      const w = canvas.width;
      const h = canvas.height;
      ctx.clearRect(0,0,w,h);
      ctx.drawImage(imgEl, 0, 0, w, h);

      const imgData = ctx.getImageData(0,0,w,h).data;
      const pixels = [];
      // sample every 4th pixel to be faster
      for (let i = 0; i < imgData.length; i += 16) {
        const r = imgData[i], g = imgData[i+1], b = imgData[i+2], a = imgData[i+3];
        if (a < 125) continue;
        // ignore near-white/near-black for palette diversity
        pixels.push([r,g,b]);
      }
      if (pixels.length === 0) return [];

      // simple k-means-ish: initialize random seeds
      const seeds = [];
      for (let i=0;i<count;i++) seeds.push(pixels[Math.floor(Math.random()*pixels.length)]);
      const clusters = new Array(count).fill().map(()=>[]);
      for (let iter=0;iter<8;iter++){
        clusters.forEach(c=>c.length=0);
        for (const p of pixels) {
          let best = 0, bestD = 1e9;
          for (let s=0;s<count;s++) {
            const d = (p[0]-seeds[s][0])**2 + (p[1]-seeds[s][1])**2 + (p[2]-seeds[s][2])**2;
            if (d < bestD) { bestD = d; best = s; }
          }
          clusters[best].push(p);
        }
        for (let s=0;s<count;s++) {
          if (clusters[s].length===0) seeds[s]=pixels[Math.floor(Math.random()*pixels.length)];
          else {
            const avg = clusters[s].reduce((acc,c)=>[acc[0]+c[0],acc[1]+c[1],acc[2]+c[2]], [0,0,0]).map(v=>Math.round(v/clusters[s].length));
            seeds[s]=avg;
          }
        }
      }
      // sort seeds by cluster size descending
      const paired = seeds.map((s,i)=>({s, size:clusters[i].length}));
      paired.sort((a,b)=>b.size-a.size);
      return paired.map(p=>p.s).slice(0,count);
    }

    function rgbToHex(rgb) {
      return '#' + rgb.map(v=>v.toString(16).padStart(2,'0')).join('');
    }

    // --- DOM references ---
    const fileInput = document.getElementById('fileInput');
    const dropZone = document.getElementById('dropZone');
    const preview = document.getElementById('preview');
    const placeholder = document.getElementById('placeholder');
    const analyzeBtn = document.getElementById('analyzeBtn');
    const clearBtn = document.getElementById('clearBtn');
    const labelsWrap = document.getElementById('labelsWrap');
    const colorsWrap = document.getElementById('colorsWrap');
    const promptBox = document.getElementById('promptBox');
    const copyBtn = document.getElementById('copyBtn');
    const presetStyle = document.getElementById('presetStyle');
    const inc_color = document.getElementById('inc_color');
    const inc_style = document.getElementById('inc_style');
    const inc_detail = document.getElementById('inc_detail');
    const regenerateBtn = document.getElementById('regenerateBtn');
    const downloadPrompt = document.getElementById('downloadPrompt');
    const exampleBtn = document.getElementById('exampleBtn');
    const downloadAll = document.getElementById('downloadAll');

    let currentImage = null;
    let mobilenetModel = null;
    let lastResult = null;

    // Load MobileNet model async
    mobilenet.load().then(m => {
      mobilenetModel = m;
      // small entrance animation
      gsap.from("header h1", {y:-10, opacity:0, duration:0.6});
    }).catch(e => {
      console.error("Gagal load model mobilenet:", e);
      alert("Gagal memuat model deteksi. Coba reload halaman.");
    });

    // Drag & drop
    dropZone.addEventListener('click', ()=>fileInput.click());
    dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('pulse'); });
    dropZone.addEventListener('dragleave', e => { dropZone.classList.remove('pulse'); });
    dropZone.addEventListener('drop', e => {
      e.preventDefault(); dropZone.classList.remove('pulse');
      const f = e.dataTransfer.files && e.dataTransfer.files[0];
      if (f) handleFile(f);
    });

    fileInput.addEventListener('change', (e)=> {
      const f = e.target.files && e.target.files[0];
      if (f) handleFile(f);
    });

    function handleFile(file) {
      if (!file.type.startsWith('image/')) { alert('Mohon unggah file gambar.'); return; }
      if (file.size > 8 * 1024 * 1024) { alert('Ukuran file maksimal 8 MB.'); return; }

      const reader = new FileReader();
      reader.onload = (ev) => {
        preview.src = ev.target.result;
        preview.style.display = 'block';
        placeholder.style.display = 'none';
        currentImage = new Image();
        currentImage.onload = ()=> {
          // small animation
          gsap.from("#thumbWrap img", {scale:0.9, opacity:0, duration:0.5, ease:"power2.out"});
        };
        currentImage.src = ev.target.result;
        lastResult = null;
        promptBox.textContent = "Siap untuk dianalisis â€” klik 'Analisis gambar'.";
        labelsWrap.innerHTML = "";
        colorsWrap.innerHTML = "";
      };
      reader.readAsDataURL(file);
    }

    clearBtn.addEventListener('click', ()=> {
      preview.src = '';
      preview.style.display = 'none';
      placeholder.style.display = 'block';
      currentImage = null;
      labelsWrap.innerHTML = '';
      colorsWrap.innerHTML = '';
      promptBox.textContent = '';
    });

    // analyze: run mobilenet + color sampler + build prompt
    analyzeBtn.addEventListener('click', async ()=> {
      if (!currentImage) { alert('Silakan unggah gambar terlebih dahulu.'); return; }
      if (!mobilenetModel) { alert('Model belum siap, tunggu beberapa detik lalu coba lagi.'); return; }

      promptBox.textContent = 'Menganalisis...';
      // model classification
      let preds = [];
      try {
        preds = await mobilenetModel.classify(currentImage);
      } catch (e) {
        console.error(e);
      }

      // extract labels (top 5)
      const labels = (preds || []).slice(0,5).map(p => ({name: p.className, prob: p.probability}));

      // dominant colors
      const colors = getDominantColorsFromImage(currentImage, 5).filter(Boolean);

      // Save last result
      lastResult = { labels, colors };

      // render labels
      labelsWrap.innerHTML = '';
      labels.forEach(l => {
        const chip = document.createElement('div');
        chip.className = 'px-3 py-1 rounded-full bg-white/6 text-xs';
        chip.textContent = `${l.name} (${(l.prob*100).toFixed(0)}%)`;
        labelsWrap.appendChild(chip);
      });

      // render colors
      colorsWrap.innerHTML = '';
      colors.forEach(c => {
        const hex = rgbToHex(c);
        const sw = document.createElement('div');
        sw.style.width = '36px';
        sw.style.height = '36px';
        sw.style.borderRadius = '8px';
        sw.style.background = hex;
        sw.title = hex;
        sw.className = 'soft-shadow';
        colorsWrap.appendChild(sw);
      });

      // build prompt
      buildPrompt(lastResult);
      // entrance animation
      gsap.from("#promptBox", {y:8, opacity:0, duration:0.5});
    });

    // Build prompt text from detected data + options
    function buildPrompt(result) {
      if (!result) { promptBox.textContent = ''; return; }
      const labels = result.labels.map(l => l.name.split(',')[0]).filter(Boolean);
      const colors = result.colors.map(c => rgbToHex(c));
      const chosenStyle = presetStyle.value;

      const parts = [];

      // main subject
      if (labels.length>0) {
        parts.push(labels.join(', '));
      } else {
        parts.push('subject');
      }

      // colors
      if (inc_color.checked && colors.length>0) {
        parts.push(`colors: ${colors.join(', ')}`);
      }

      // style presets
      if (chosenStyle) {
        if (chosenStyle === 'anime') {
          parts.push('anime style, vibrant colors, cel shading, dramatic rim light');
        } else if (chosenStyle === 'photoreal') {
          parts.push('photorealistic, ultra-detailed, 50mm lens, cinematic lighting');
        } else if (chosenStyle === 'digital-paint') {
          parts.push('digital painting, brush strokes, painterly, soft lighting');
        } else if (chosenStyle === 'cinematic') {
          parts.push('cinematic, wide angle, dramatic lighting, volumetric fog');
        }
      } else if (inc_style.checked) {
        parts.push('soft cinematic lighting, high detail, realistic shadows');
      }

      // detail level
      if (inc_detail.checked) {
        parts.push('ultra-detailed, intricate textures, high resolution, 8k');
      }

      // camera / composition heuristics
      parts.push('composition: close-up, shallow depth of field, high contrast');

      // negative prompts (brief)
      const negative = 'lowres, blurry, watermark, deformed, text';

      const prompt = parts.join(' â€¢ ') + '\n\nNegative: ' + negative;
      promptBox.textContent = prompt;
      return prompt;
    }

    // copy to clipboard
    copyBtn.addEventListener('click', async ()=> {
      const txt = promptBox.textContent || '';
      if (!txt) return alert('Belum ada prompt untuk disalin.');
      try {
        await navigator.clipboard.writeText(txt);
        copyBtn.textContent = 'Disalin âœ“';
        setTimeout(()=>copyBtn.textContent = 'Salin', 1500);
      } catch(e) {
        alert('Gagal menyalin. Gunakan manual copy.');
      }
    });

    // regenerate uses same result but new wording
    regenerateBtn.addEventListener('click', ()=> {
      if (!lastResult) return alert('Belum ada analisis. Unggah & analisis gambar dulu.');
      // shuffle some phrasing for variety
      const styleVariants = [
        'vibrant color palette, dramatic rim light',
        'soft ambient lighting, painterly finish',
        'cinematic high contrast, volumetric light beams',
        'ultra-detailed textures, photoreal rendering'
      ];
      // randomly append one variant
      const idx = Math.floor(Math.random()*styleVariants.length);
      // temporarily toggle a style
      const saved = presetStyle.value;
      presetStyle.value = ''; // remove preset to use custom
      // attach variant to prompt by temporarily toggling inc_style
      const originalInc = inc_style.checked;
      inc_style.checked = true;
      const p = buildPrompt(lastResult) + '\nVariant: ' + styleVariants[idx];
      promptBox.textContent = p;
      // restore
      presetStyle.value = saved;
      inc_style.checked = originalInc;
      gsap.from("#promptBox", {scale:0.99, opacity:0, duration:0.35});
    });

    // download prompt as .txt
    downloadPrompt.addEventListener('click', ()=> {
      const txt = promptBox.textContent || '';
      if (!txt) return alert('Belum ada prompt.');
      const blob = new Blob([txt], {type: 'text/plain'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'prompt.txt';
      a.click();
      URL.revokeObjectURL(url);
    });

    // sample button: load example image from web (CORS-friendly)
    exampleBtn.addEventListener('click', ()=> {
      // small built-in example image (data URL or remote host with CORS)
      const exampleUrl = 'https://images.unsplash.com/photo-1542272605-79a9f0b126c2?w=1200&q=80&auto=format&fit=crop';
      preview.src = exampleUrl;
      preview.style.display = 'block';
      placeholder.style.display = 'none';
      currentImage = new Image();
      currentImage.crossOrigin = 'anonymous';
      currentImage.onload = ()=> {
        lastResult = null;
        promptBox.textContent = "Siap untuk dianalisis â€” klik 'Analisis gambar'.";
      };
      currentImage.src = exampleUrl;
    });

    // optional: download prompt + metadata as single file
    downloadAll.addEventListener('click', ()=> {
      if (!lastResult) return alert('Belum ada analisis.');
      const content = [
        '=== Prompt ===',
        promptBox.textContent,
        '',
        '=== Labels ===',
        lastResult.labels.map(l=>`${l.name} (${(l.prob*100).toFixed(1)}%)`).join('\n'),
        '',
        '=== Colors ===',
        lastResult.colors.map(c=>rgbToHex(c)).join(', ')
      ].join('\n\n');
      const blob = new Blob([content], {type: 'text/plain'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'prompt_and_meta.txt';
      a.click();
      URL.revokeObjectURL(url);
    });

    // small animation on load
    window.addEventListener('load', ()=> {
      gsap.from(".card", {y:8, opacity:0, duration:0.6, stagger:0.08});
    });

    // keyboard: press Enter in file input area to open dialog
    dropZone.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') fileInput.click();
    });
  </script>
</body>
                  </html>
